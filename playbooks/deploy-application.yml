---
- name: Create a VM on OpenShift Virtualization
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # VM details
    vm_name: test-vm
    vm_project: demo-test
    helper_pod_name: "pvc-file-retriever"
    helper_image: "registry.access.redhat.com/ubi8/ubi-minimal:latest"
    mount_path: "/mnt/pvc"
    pvc_name: bonjour-artifacts
    file_path_in_volume: artifacts

    #application specifics
    deployment_name: bonjour
    deployment_version: 1_0_0

  tasks:        
  - name: Retrieve Artifact
    block:
      - name: 1. Create the helper pod definition
        set_fact:
          helper_pod_manifest:
            apiVersion: v1
            kind: Pod
            metadata:
              name: "{{ helper_pod_name }}"
              namespace: "{{ vm_project }}"
            spec:
              containers:
                - name: helper-container
                  image: "{{ helper_image }}"
                  # Pod needs to stay alive while we copy
                  command: [ "sleep", "3600" ]
                  volumeMounts:
                    - name: target-volume
                      mountPath: "{{ mount_path }}"
                      readOnly: true
              volumes:
                - name: target-volume
                  persistentVolumeClaim:
                    claimName: "{{ pvc_name }}"
              # Ensure the pod doesn't try to restart on failure
              restartPolicy: Never

      - name: 2. Launch the helper pod
        kubernetes.core.k8s:
          state: present
          definition: "{{ helper_pod_manifest }}"

      - name: 3. Wait for the helper pod to be in 'Running' state
        kubernetes.core.k8s_info:
          kind: Pod
          name: "{{ helper_pod_name }}"
          namespace: "{{ vm_project }}"
          wait: yes
          wait_condition:
            type: Ready
            status: "True"
          wait_timeout: 300 # 5 minute timeout
        register: pod_info
        # This assertion is for safety
        failed_when: pod_info.resources[0].status.phase != 'Running'

      - name: 4. Copy the file from the pod to the local machine
        kubernetes.core.k8s_cp:
          state: from_pod
          pod: "{{ helper_pod_name }}"
          namespace: "{{ vm_project }}"
          # We combine the mount path with the file path.
          # The regex_replace ensures we don't get double slashes (e.g., /mnt/pvc//data)
          src: "{{ mount_path }}/{{ file_path_in_volume }}/{{deployment_name}}-{{deployment_version}}.tar.gz"
          dest: "{{ local_dest_path }}"
        
        # Use 'changed_when: true' to always show this task as "changed"
        changed_when: true
        notify:
          - file_copied_success

    # This 'always' block is critical for cleanup.
    # It runs whether the 'block' succeeded or failed.
    always:
      - name: 5. (Cleanup) Delete the helper pod
        kubernetes.core.k8s:
          state: absent
          definition: "{{ helper_pod_manifest }}"
        # We don't want this task to fail if the pod was never created
        ignore_errors: true

  - name: "Copy file to VM using 'virtctl scp'"
      # We use 'ansible.builtin.command' to build the exact
      # virtctl command string.
    ansible.builtin.command: >
      virtctl scp
      -n {{ vm_project }}
      {{ local_dest_path }}/{{ deployment_name }}-{{deployment_version}}.tar.gz
      redhat@{{ vm_name }}:/tmp/
    register: virtctl_output
    changed_when: true # A file copy is always considered a change