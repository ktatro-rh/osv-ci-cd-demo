---
- name: Update the VM
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # VM details
    vm_name: test-vm
    vm_project: default
    deployment_version: 1.0.0

  tasks:

    - name: Apply multiple patch operations to an existing Pod
      kubernetes.core.k8s_json_patch:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        namespace: "{{ vm_project }}"
        name: "{{ vm_name }}"
        patch:
        - op: replace
          path: /spec/dataVolumeTemplates/0/metadata/name
          value: "{{ vm_name }}-{{ deployment_version }}"
        patch:
        - op: replace
          path: /spec/template/spec/volumes/dataVolume/0/name
          value: "{{ vm_name }}-{{ deployment_version }}"