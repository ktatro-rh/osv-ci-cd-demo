---
- name: Update the VM
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
 
    - name: set label on new vm
      when: is_new == false
      kubernetes.core.k8s:
        state: patched
        kind: VirtualMachine
        namespace: "{{ vm_project }}"
        name: "{{ vm_name_temporary }}"
        definition:
          metadata:
            lables:
              app: "{{ vm_name }}"

    - name: remove the old VM
      when: is_new == false
      redhat.openshift_virtualization.kubevirt_vm:
        state: absent
        name: "{{ existing_vm }}"
        namespace: "{{ vm_project }}"

    - name: set workflow data
      ansible.builtin.set_stats:
        data:
          route_name: "{{ vm_name }}-route"